#!/bin/zsh
# automat installs packages from the Internet into the ~/.local hierarchy.


install_root=~/table/root
build_dir="$install_root/tmp/automat"

packages=("htop" "vim" "libevent")
typeset -A urls
urls=("htop"   "http://downloads.sourceforge.net/project/htop/htop/1.0.2/htop-1.0.2.tar.gz"
      "vim"    "ftp://ftp.vim.org/pub/vim/unix/vim-7.4.tar.bz2")


usage() {
  # Display a little table of available packages.
  tabletext=""
  i=0
  # (o) is alphabetic sort.
  for package in ${(o)packages}; do
    tabletext+="$package"
    i+=1
    if ((i % 3 == 0)); then
      tabletext+="\n"
    else
      tabletext+=" "
    fi
  done
  print "No packages specified. Available packages:"
  print $tabletext | column -t | sed 's/^/  /'
}


cleanup() {
  cd ~
  rm -rf $build_dir
}


# main
if ((${#@} == 0)); then
  usage
  exit 1
fi

# Clean up after ourselves on ^C, at least.
trap cleanup 2

mkdir -p "$build_dir" >/dev/null 2>/dev/null
for arg in $@; do
  if [ ! ${packages[(R)$arg]} ]; then
    print "Don't know how to 'mat $arg!"
    continue
  fi

  # Build each package in its own directory.
  cd $build_dir
  mkdir $arg >/dev/null 2>/dev/null
  cd $arg

  print "Fetching $arg..."
  url=$urls[$arg]
  wget -q $url

  print "Unpacking $arg..."
  if [ ! ${url##*.tar.*} ]; then
    tar -xf *
    rm -f *.tar.*
    cd *
  fi

  print "Building $arg..."
  if [ -e configure ]; then
    ./configure --prefix=$install_root --bindir=$install_root/bin
    make -j 4
    make install
  fi
done
cleanup

