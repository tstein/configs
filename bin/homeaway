#!/bin/zsh


progname=`basename $0`
usage() {
    print "usage: $progname host file [file...]"
}


# We probably need the envvars for ssh-agent to get any data across.
setup_ssh() {
    . ~/.keychain/`hostname -s`-sh
}


sync() {
    # Create the necessary directory chain on the destination host.
    bottom_dir=$1
    if [ ! -d $1 ]; then
        bottom_dir=`dirname $1`
    fi
    ssh $desthost "mkdir -p '$bottom_dir'"

    print "syncing $1..."
    rsync -ave ssh --delete "$1/" $desthost:"\"$1\""
    print
}


main() {
    if (( ${#argv} == 0 )); then
        usage
        exit 1
    fi
    if (( ${#argv} == 1 )); then
        print "$progname: no files specified"
        exit 1
    fi

    desthost=$1
    shift 1

    setup_ssh
    for i in $argv; do
        abspath=`readlink -m $i`
        sync $i
    done
}


main $@

